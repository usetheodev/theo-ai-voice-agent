# ==============================================================================
# MEDIA SERVER - CONFIGURAÇÃO DE VARIÁVEIS DE AMBIENTE
# ==============================================================================
#
# Este arquivo documenta TODAS as variáveis de ambiente disponíveis para
# configurar o Media Server (SIP Bridge).
#
# COMO USAR:
# 1. Copie este arquivo para .env
# 2. Ajuste os valores conforme seu ambiente
# 3. Variáveis comentadas usam valores padrão seguros
#
# DICA: Em produção, configure variáveis sensíveis (senhas, IPs) via
# Docker secrets ou variáveis de ambiente do sistema operacional.
#
# ==============================================================================


# ==============================================================================
# AI AGENT - CONEXÃO WEBSOCKET
# ==============================================================================
# Configurações de conexão com o servidor AI Agent via WebSocket.
# O Media Server atua como ponte entre SIP/RTP e o AI Agent.

# URL do servidor WebSocket do AI Agent
# - Docker: use o nome do serviço (ex: ws://ai-agent:8765)
# - Local: use localhost (ex: ws://127.0.0.1:8765)
# - Produção: use hostname/IP interno da rede
WEBSOCKET_URL=ws://ai-agent:8765

# Intervalo entre tentativas de reconexão (segundos)
# - Valores menores = reconexão mais rápida, mais carga no servidor
# - Valores maiores = menos tentativas, maior tempo offline
# - Recomendado: 3-10 segundos
WS_RECONNECT_INTERVAL=5

# Número máximo de tentativas de reconexão antes de desistir
# - Após esgotar, o Media Server para de tentar reconectar
# - Use 0 para tentativas infinitas (não recomendado)
# - Recomendado: 5-20 tentativas
WS_MAX_RECONNECT_ATTEMPTS=10

# Intervalo de ping para manter conexão viva (segundos)
# - Evita timeout por inatividade em firewalls/load balancers
# - Deve ser menor que o timeout do servidor
# - Recomendado: 20-60 segundos
WS_PING_INTERVAL=30

# Timeout do ping WebSocket (segundos)
# - Se não receber pong em tempo, considera conexão morta
# - Deve ser menor que o ping_interval
# - Recomendado: 5-15 segundos
WS_PING_TIMEOUT=10

# Timeout para fechar conexão WebSocket graciosamente (segundos)
# - Tempo máximo para aguardar fechamento limpo
# - Recomendado: 3-10 segundos
WS_CLOSE_TIMEOUT=5

# Timeout para iniciar sessão de áudio (segundos)
# - Tempo máximo para aguardar confirmação do AI Agent
# - Inclui negociação ASP se habilitada
# - Recomendado: 5-15 segundos
WS_SESSION_START_TIMEOUT=10


# ==============================================================================
# ASTERISK/SIP - CONFIGURAÇÃO DE TELEFONIA
# ==============================================================================
# Configurações para registro e comunicação com o servidor SIP (Asterisk).

# Domínio/IP do servidor SIP (Asterisk)
# - Docker: use o nome do serviço (ex: asterisk)
# - Local: use localhost ou 127.0.0.1
# - Produção: use hostname/IP do servidor Asterisk
SIP_DOMAIN=asterisk

# Porta SIP do servidor
# - Padrão Asterisk: 5060 (UDP) ou 5061 (TLS)
# - Este projeto usa: 5160 (para não conflitar com instalações locais)
SIP_PORT=5160

# Protocolo de transporte SIP
# - udp: mais rápido, padrão para redes internas (RECOMENDADO)
# - tcp: mais confiável, necessário para mensagens grandes
# - tls: criptografado, obrigatório para produção na internet
SIP_TRANSPORT=udp

# Nome de usuário/ramal SIP para registro
# - Deve corresponder a um endpoint configurado no Asterisk (pjsip.conf)
# - O ramal 2000 é reservado para o AI Agent neste projeto
SIP_USERNAME=2000

# Senha do ramal SIP
# - IMPORTANTE: Troque esta senha em produção!
# - Use senhas fortes (16+ caracteres, alfanuméricos)
# - Nunca comite senhas reais no repositório
SIP_PASSWORD=7Wslll0Hlc6BCOv4jF51

# Nome de exibição (Caller ID) para chamadas originadas
# - Aparece no telefone do destinatário
# - Use algo descritivo como "Agente IA", "Atendimento Virtual"
SIP_DISPLAY_NAME=Agente IA

# Codecs de áudio permitidos (separados por vírgula)
# - Ordem define preferência na negociação SDP
# - Opções disponíveis:
#   - PCMU: G.711 µ-law (padrão EUA/Japão, 64kbps) - RECOMENDADO
#   - PCMA: G.711 A-law (padrão Europa/Brasil, 64kbps) - RECOMENDADO
#   - G729: baixa banda (8kbps), requer licença
#   - opus: alta qualidade, ideal para WebRTC
# - Para telefonia tradicional, use: PCMU,PCMA
# SIP_CODECS=PCMU,PCMA

# Porta RTP inicial para mídia de áudio
# - Range de portas UDP para streams RTP
# - Deve estar liberado no firewall
# - Recomendado: range de 100+ portas para múltiplas chamadas
RTP_PORT_START=40000

# Porta RTP final para mídia de áudio
# - Cada chamada usa ~2 portas (RTP + RTCP)
# - Range de 100 portas = ~50 chamadas simultâneas
RTP_PORT_END=40100


# ==============================================================================
# ÁUDIO - PROCESSAMENTO DE VOZ
# ==============================================================================
# Configurações de processamento de áudio para captura e reprodução.

# Taxa de amostragem do áudio (Hz)
# - 8000: padrão telefonia PSTN (RECOMENDADO para VoIP)
# - 16000: wideband, melhor qualidade, mais banda
# - 48000: alta fidelidade, usado em WebRTC
# ATENÇÃO: Alterar requer ajustar outros parâmetros de áudio
AUDIO_SAMPLE_RATE=8000

# Número de canais de áudio
# - 1: mono (OBRIGATÓRIO para telefonia SIP)
# - 2: stereo (não suportado em telefonia)
AUDIO_CHANNELS=1

# Largura da amostra em bytes
# - 2: 16-bit PCM (PADRÃO para telefonia)
# - 1: 8-bit (qualidade inferior)
# - 4: 32-bit (desnecessário para voz)
AUDIO_SAMPLE_WIDTH=2

# Duração de cada frame RTP em milissegundos
# - 20ms: padrão VoIP, bom equilíbrio latência/eficiência (RECOMENDADO)
# - 10ms: menor latência, mais overhead de rede
# - 30ms: maior eficiência, maior latência percebida
# ATENÇÃO: Deve ser compatível com o servidor SIP
AUDIO_FRAME_DURATION_MS=20

# Tamanho máximo do buffer de envio em bytes
# - Acumula áudio antes de enviar para reduzir overhead
# - 1600 bytes = 100ms de áudio @ 8kHz, 16-bit mono
# - Valores maiores = maior latência, menos pacotes
# - Valores menores = menor latência, mais overhead
# Fórmula: sample_rate * (ms/1000) * sample_width * channels
AUDIO_SEND_BUFFER_MAX=1600


# ==============================================================================
# VAD - DETECÇÃO DE ATIVIDADE DE VOZ
# ==============================================================================
# Configurações do Voice Activity Detection para detectar fala e silêncio.
# VAD é CRÍTICO para determinar quando o usuário terminou de falar.

# Threshold de silêncio para detectar fim de fala (milissegundos)
# - Tempo de silêncio contínuo para considerar que o usuário parou de falar
# - Pausas naturais na fala: 200-400ms
# - Valores menores (<400ms): mais responsivo, pode cortar frases
# - Valores maiores (>700ms): mais robusto, maior latência percebida
# RECOMENDADO: 500-700ms para português brasileiro
SILENCE_THRESHOLD_MS=500

# Agressividade do VAD (0-3)
# - 0: muito permissivo, detecta mais fala, mais falsos positivos
# - 1: permissivo, bom para ambientes silenciosos
# - 2: moderado, bom equilíbrio (RECOMENDADO)
# - 3: agressivo, filtra mais ruído, pode perder fala suave
# DICA: Em ambientes barulhentos, use 2-3. Em estúdio, use 0-1.
VAD_AGGRESSIVENESS=2

# Duração mínima de fala para ser considerada válida (milissegundos)
# - Ignora sons muito curtos (ruídos, cliques)
# - Palavras curtas ("sim", "não", "ok"): 200-300ms
# - Valores menores: captura mais, mais falsos positivos
# - Valores maiores: menos ruído, pode perder respostas curtas
# RECOMENDADO: 200-300ms
VAD_MIN_SPEECH_MS=250

# Threshold de energia RMS para fallback VAD
# - Usado quando webrtcvad não está disponível
# - Valor RMS abaixo do qual é considerado silêncio
# - Depende do ganho do microfone e nível de ruído
# - Valores típicos: 300-800
# DICA: Meça o ruído ambiente e ajuste ~2x acima
VAD_ENERGY_THRESHOLD=500

# Tamanho do ring buffer do VAD em frames
# - Número de frames usados para suavização da detecção
# - Evita detecções espúrias por ruídos isolados
# - 5 frames @ 20ms = 100ms de janela
# - Valores maiores: mais estável, maior latência
VAD_RING_BUFFER_SIZE=5

# Taxa mínima de frames com fala para considerar que há fala (0.0 - 1.0)
# - 0.4 = 40% dos frames no ring buffer devem ter fala detectada
# - Valores menores: mais sensível, mais falsos positivos
# - Valores maiores: mais robusto, pode perder fala suave
# RECOMENDADO: 0.3-0.5
VAD_SPEECH_RATIO_THRESHOLD=0.4


# ==============================================================================
# CHAMADA - COMPORTAMENTO DE CONVERSAÇÃO
# ==============================================================================
# Configurações que afetam o comportamento durante uma chamada ativa.

# Habilitar barge-in (interrupção pelo usuário)
# - true: usuário pode interromper a IA enquanto ela fala
# - false: usuário deve aguardar a IA terminar de falar
# RECOMENDADO: true para experiência natural de conversação
BARGE_IN_ENABLED=true

# Timeout para aguardar greeting do AI Agent (segundos)
# - Tempo máximo para receber a mensagem inicial do agente
# - Se expirar, a conversa inicia sem greeting
# - Recomendado: 15-30 segundos (depende da latência do LLM)
CALL_GREETING_TIMEOUT=30

# Timeout para aguardar início de sessão de áudio (segundos)
# - Tempo máximo para estabelecer sessão com AI Agent
# - Inclui conexão WebSocket + handshake ASP
# - Recomendado: 30-60 segundos
CALL_SESSION_START_TIMEOUT=60

# Timeout para aguardar playback esvaziar (segundos)
# - Tempo máximo para o buffer de reprodução esvaziar
# - Evita travamento se houver problemas de áudio
# - Recomendado: 5-15 segundos
CALL_PLAYBACK_DRAIN_TIMEOUT=10

# Intervalo de verificação do buffer de playback (segundos)
# - Frequência de checagem se o buffer esvaziou
# - Valores menores: resposta mais rápida, mais CPU
# - Recomendado: 0.05-0.1 segundos (50-100ms)
CALL_PLAYBACK_CHECK_INTERVAL=0.05

# Delay inicial após conexão de mídia (segundos)
# - Aguarda mídia estabilizar antes de iniciar processamento
# - Evita problemas de sincronização inicial
# - Recomendado: 0.1-0.3 segundos
CALL_MEDIA_READY_DELAY=0.1

# Intervalo do loop de conversação (segundos)
# - Frequência do loop principal de processamento
# - Valores menores: mais responsivo, mais CPU
# - Recomendado: 0.05-0.1 segundos
CALL_CONVERSATION_LOOP_INTERVAL=0.05


# ==============================================================================
# PJSIP - CONFIGURAÇÕES INTERNAS
# ==============================================================================
# Configurações do motor PJSIP/PJSUA2. Altere apenas se souber o que está fazendo.

# Clock rate interno do PJSUA2 (Hz)
# - Taxa de amostragem interna para processamento
# - 16000 é o padrão do PJSUA2
# - ATENÇÃO: Alterar pode causar problemas de resampling
PJSIP_INTERNAL_CLOCK_RATE=16000

# Bits por sample para processamento interno
# - 16-bit é o padrão PCM
# - Não há motivo para alterar
PJSIP_INTERNAL_BITS_PER_SAMPLE=16


# ==============================================================================
# QUALIDADE RTP - MONITORAMENTO DE MÍDIA
# ==============================================================================
# Configurações para monitoramento de qualidade da mídia RTP.

# Intervalo esperado entre frames RTP (milissegundos)
# - Deve corresponder ao AUDIO_FRAME_DURATION_MS
# - Usado para calcular jitter e packet loss
RTP_EXPECTED_INTERVAL_MS=20.0

# Fator multiplicador para detectar gaps (possível packet loss)
# - Gap > intervalo_esperado * fator = possível perda de pacotes
# - 1.5 = gap de 30ms+ indica possível perda (para frames de 20ms)
# - Valores menores: mais sensível, mais falsos positivos
# - Valores maiores: menos alarmes, pode perder perdas reais
RTP_GAP_THRESHOLD_FACTOR=1.5


# ==============================================================================
# LOGGING - CONFIGURAÇÃO DE LOGS
# ==============================================================================
# Níveis de log para debugging e monitoramento.

# Nível de log da aplicação Python
# - DEBUG: muito verboso, inclui todos os frames de áudio
# - INFO: operações normais, início/fim de chamadas (RECOMENDADO)
# - WARNING: apenas alertas e erros
# - ERROR: apenas erros
# - CRITICAL: apenas erros fatais
LOG_LEVEL=INFO

# Nível de log do PJSIP (0-5)
# - 0: desabilitado
# - 1: erros apenas
# - 2: avisos
# - 3: informativo (RECOMENDADO)
# - 4: debug
# - 5: trace (MUITO verboso, impacta performance)
# DICA: Use 4-5 apenas para debugging de problemas SIP específicos
PJSIP_LOG_LEVEL=3


# ==============================================================================
# MÉTRICAS - PROMETHEUS
# ==============================================================================
# Configurações do servidor de métricas Prometheus.

# Porta do servidor HTTP para métricas Prometheus
# - Expõe endpoint /metrics para scraping
# - Deve ser diferente de outros serviços
# - Padrão neste projeto: 9091 (AI Agent usa 9090)
METRICS_PORT=9091

# Habilitar servidor de métricas
# - true: inicia servidor HTTP para métricas
# - false: desabilita métricas (economia de recursos)
# RECOMENDADO: true em produção para observabilidade
METRICS_ENABLED=true


# ==============================================================================
# SBC - SESSION BORDER CONTROLLER (OPCIONAL)
# ==============================================================================
# Configurações para conexão via SBC externo (ex: AWS NLB, Twilio, etc).
# Use quando não há Asterisk local, ou para troncos SIP externos.

# Habilitar modo SBC
# - true: conecta via SBC externo em vez de Asterisk direto
# - false: conecta diretamente ao Asterisk (PADRÃO)
SBC_ENABLED=false

# Hostname/IP do SBC
# - Ex: nlb-sbc.us-east-1.elb.amazonaws.com
# - Ex: sip.twilio.com
# SBC_HOST=

# Porta do SBC
# - Padrão SIP: 5060 (UDP/TCP) ou 5061 (TLS)
SBC_PORT=5060

# Protocolo de transporte para o SBC
# - udp: padrão, mais rápido
# - tcp: mais confiável para NAT
# - tls: criptografado, recomendado para internet pública
SBC_TRANSPORT=udp

# Outbound proxy (opcional)
# - Se não definido, usa sip:SBC_HOST:SBC_PORT automaticamente
# - Formato: sip:host:port;transport=tcp
# SBC_OUTBOUND_PROXY=

# Realm para autenticação SIP
# - * = aceita qualquer realm (PADRÃO)
# - Especifique se o SBC exigir realm específico
SBC_REALM=*

# Habilitar registro SIP no SBC
# - true: registra no SBC para receber chamadas (RECOMENDADO)
# - false: modo sem registro, apenas chamadas originadas
SBC_REGISTER=true

# IP público para NAT traversal
# - Necessário se o Media Server está atrás de NAT
# - O SBC precisa saber o IP público para rotear mídia
# - Deixe vazio se não estiver atrás de NAT
# SBC_PUBLIC_IP=

# Intervalo de keep-alive UDP (segundos)
# - Mantém mapeamento NAT ativo
# - 0 = desabilitado
# - Recomendado: 15-30 segundos para NAT residencial
SBC_KEEP_ALIVE=30

# Timeout de registro SIP (segundos)
# - Tempo de expiração do registro no SBC
# - Após expirar, re-registra automaticamente
# - Recomendado: 60-300 segundos
SBC_REGISTER_TIMEOUT=300
