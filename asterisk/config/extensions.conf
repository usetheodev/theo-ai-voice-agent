;===============================================
; Dialplan - PABX Interno com URA
;===============================================

[general]
static=yes
writeprotect=no
clearglobalvars=no

[globals]
OPERADOR=1001
SUPORTE=1002
TIMEOUT_URA=10

;===============================================
; CONTEXTO INTERNO - Chamadas entre ramais
;===============================================
[interno]

; Chamadas diretas entre ramais (1001-1005)
exten => _100X,1,NoOp(Chamada para ramal ${EXTEN})
 same => n,Set(CALLERID(name)=${CALLERID(name)})
 same => n,Dial(PJSIP/${EXTEN},30,tT)
 same => n,VoiceMail(${EXTEN}@default,u)
 same => n,Hangup()

; Ramal 2000 - AI Agent (Media Server)
; Passa channel name do caller via header SIP para o Media Server
; O Media Server usa isso para AMI Redirect em transfers
; __CALLER_CHAN: duplo underscore = variavel herdada pelo canal B (outgoing)
; b() pre-dial handler: executa no canal B ANTES do INVITE ser enviado
exten => 2000,1,NoOp(Chamada para AI Agent)
 same => n,Set(CALLERID(name)=${CALLERID(name)})
 same => n,Set(__CALLER_CHAN=${CHANNEL})
 same => n,Dial(PJSIP/2000,60,tTb(add-caller-header^s^1))
 same => n,Hangup()

;--- Pre-dial handler: seta X-Caller-Channel no canal B ---
[add-caller-header]
exten => s,1,Set(PJSIP_HEADER(add,X-Caller-Channel)=${CALLER_CHAN})
 same => n,Return()

; Acessar URA discando 9
exten => 9,1,NoOp(Acesso à URA)
 same => n,Goto(ura-principal,s,1)

; Echo test - discar *43
exten => *43,1,NoOp(Teste de Echo)
 same => n,Answer()
 same => n,Playback(demo-echotest)
 same => n,Echo()
 same => n,Playback(demo-echodone)
 same => n,Hangup()

; Hora certa - discar *60
exten => *60,1,NoOp(Hora certa)
 same => n,Answer()
 same => n,SayUnixTime(,,ABdY 'digits/at' IMp)
 same => n,Hangup()

; Conferência simples - discar 8000
exten => 8000,1,NoOp(Sala de Conferência)
 same => n,Answer()
 same => n,ConfBridge(1)
 same => n,Hangup()

;===============================================
; URA PRINCIPAL
;===============================================
[ura-principal]

exten => s,1,NoOp(=== INICIO DA URA ===)
 same => n,Answer()
 same => n,Wait(1)

 ; Menu principal usando áudios padrão
 same => n(menu),Playback(hello)
 same => n,Playback(basic-pbx-ivr-main)

 ; Aguarda opção
 same => n,Set(TIMEOUT(digit)=5)
 same => n,Set(TIMEOUT(response)=${TIMEOUT_URA})
 same => n,Background(silence/3)
 same => n,WaitExten(${TIMEOUT_URA})

 ; Se não digitou nada
 same => n,Playback(goodbye)
 same => n,Hangup()

; Opção 1 - Falar com Operador
exten => 1,1,NoOp(URA: Opção 1 - Operador)
 same => n,Playback(pls-wait-connect-call)
 same => n,Dial(PJSIP/${OPERADOR},30,tT)
 same => n,VoiceMail(${OPERADOR}@default,u)
 same => n,Hangup()

; Opção 2 - Falar com Suporte
exten => 2,1,NoOp(URA: Opção 2 - Suporte)
 same => n,Playback(pls-wait-connect-call)
 same => n,Dial(PJSIP/${SUPORTE},30,tT)
 same => n,VoiceMail(${SUPORTE}@default,u)
 same => n,Hangup()

; Opção 3 - Discar ramal diretamente
; SEGURANÇA: Apenas ramais 1001-1005 e 2000 são permitidos
exten => 3,1,NoOp(URA: Opção 3 - Discar ramal)
 same => n,Playback(enter-ext-of-person)
 same => n,Read(RAMAL,,4,,,5)
 same => n,GotoIf($["${RAMAL}" = ""]?ura-principal,s,menu)
 same => n,GotoIf($[${RAMAL} >= 1001 & ${RAMAL} <= 1005]?dial)
 same => n,GotoIf($[${RAMAL} = 2000]?dial)
 same => n,NoOp(URA: Ramal ${RAMAL} não permitido)
 same => n,Playback(invalid)
 same => n,Goto(ura-principal,s,menu)
 same => n(dial),Dial(PJSIP/${RAMAL},30,tT)
 same => n,Goto(ura-principal,s,menu)

; Opção 0 - Repetir menu
exten => 0,1,NoOp(URA: Repetir menu)
 same => n,Goto(ura-principal,s,menu)

; Opção inválida
exten => i,1,NoOp(URA: Opção inválida)
 same => n,Playback(invalid)
 same => n,Goto(ura-principal,s,menu)

; Timeout
exten => t,1,NoOp(URA: Timeout)
 same => n,Playback(goodbye)
 same => n,Hangup()

;===============================================
; TRANSFER ASSISTIDA - Controle via AMI
; Caller chega aqui via AMI Redirect do Media Server
; quando o AI Agent decide transferir a chamada.
;
; Fluxo: AI decide -> Media Server AMI Redirect -> este contexto
; Fallback: se destino nao atende -> volta pro AI Agent (nova sessao)
;===============================================
[transfer-assistida]

exten => _X.,1,NoOp(Transfer assistida para ${EXTEN})
 same => n,Answer()
 same => n,Playback(pls-wait-connect-call)
 same => n,Dial(PJSIP/${EXTEN},30,tTm(default))
 same => n,NoOp(DIALSTATUS=${DIALSTATUS})
 same => n,GotoIf($["${DIALSTATUS}" = "ANSWER"]?done:no-answer)
 same => n(done),Hangup()
 same => n(no-answer),NoOp(Transfer falhou - retornando ao AI Agent)
 same => n,Playback(an-error-has-occurred)
 same => n,Set(__CALLER_CHAN=${CHANNEL})
 same => n,Dial(PJSIP/2000,60,tTb(add-caller-header^s^1))
 same => n,Hangup()

;===============================================
; CONTEXTO DE ENTRADA (para troncos futuros)
; SEGURANÇA: Rejeita tudo por padrão
; Adicione DIDs específicos conforme necessário
;===============================================
[from-external]

; Exemplo: Aceitar DID específico (descomente e ajuste)
; exten => 551199999999,1,NoOp(DID: ${EXTEN})
;  same => n,Goto(ura-principal,s,1)

; SEGURANÇA: Rejeita qualquer outro número
exten => _X.,1,NoOp(BLOCKED: Tentativa não autorizada para ${EXTEN} de ${CALLERID(num)})
 same => n,Log(WARNING,Chamada bloqueada: ${CALLERID(all)} -> ${EXTEN})
 same => n,Congestion()
 same => n,Hangup()
